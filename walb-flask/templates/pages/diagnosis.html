{% extends "base.html" %} {% set page_title = "보안 진단" %} {% block title %}{{ page_title }}{% endblock %} {% block content %}
<!-- 히어로 헤더 -->
<div class="bg-gradient-to-r from-purple-600 to-pink-600 rounded-2xl p-8 text-white mb-8 relative overflow-hidden">
                <div class="relative z-10">
                    <div class="flex items-center mb-4">
                        <span class="text-4xl mr-4 animate-bounce">🔍</span>
                        <div>
                            <h1 class="text-3xl font-bold mb-2">AWS 인프라 종합 보안 진단 & 자동 조치</h1>
                            <p class="text-purple-100">총 41개 항목 완전 자동화 (KISA ISMS-P 31개 점검 항목 + 2024 SK Shieldus 클라우드 보안 가이드라인 10개)</p>
                        </div>
                    </div>
                </div>

                <!-- Background Pattern -->
                <div class="absolute inset-0 opacity-10">
                    <div class="absolute top-10 right-10 w-20 h-20 bg-white rounded-full animate-pulse"></div>
                    <div class="absolute bottom-10 right-20 w-16 h-16 bg-white rounded-full animate-pulse delay-1000"></div>
                    <div class="absolute top-20 left-20 w-12 h-12 bg-white rounded-full animate-pulse delay-2000"></div>
                </div>
            </div>

            <!-- 계정 선택 섹션 -->
            <div class="account-selection-section">
                <h2 class="section-title">
                    <span class="section-icon">☁️</span>
                    연결된 AWS 계정
                </h2>

                {% if accounts %}
                <div class="accounts-grid">
                    {% for account in accounts %}
                    <div class="account-card {% if selected_account and selected_account.account_id == account.account_id %}selected{% endif %}" data-account-id="{{ account.account_id }}" onclick="selectAccount('{{ account.account_id }}')">
                        <div class="account-header">
                            <h3 class="account-name">{{ account.cloud_name }}</h3>
                            <div class="account-type-badge">
                                {% if account.connection_type == 'role' %}
                                <span class="badge badge-role">Role</span>
                                {% else %}
                                <span class="badge badge-key">Key</span>
                                {% endif %}
                            </div>
                        </div>
                        <div class="account-details">
                            <div class="account-detail">
                                <span class="detail-label">계정 ID</span>
                                <span class="detail-value">{{ account.account_id }}</span>
                            </div>
                            <div class="account-detail">
                                <span class="detail-label">리전</span>
                                <span class="detail-value">{{ account.primary_region }}</span>
                            </div>
                        </div>
                    </div>
                    {% endfor %}
                </div>
                {% else %}
                <div class="empty-state">
                    <div class="empty-icon">📋</div>
                    {% if failed_accounts_count > 0 %}
                    <h3>진단 가능한 AWS 계정이 없습니다</h3>
                    <p>보안 진단을 위해서는 AWS 계정이 연결된 상태여야 합니다.</p>
                    <div class="bg-yellow-50 border border-yellow-200 rounded-lg p-4 mb-4">
                        <div class="flex items-start">
                            <span class="text-yellow-600 text-lg mr-3">⚠️</span>
                            <div class="text-sm text-yellow-800">
                                <strong>{{ failed_accounts_count }}개 계정의 연결이 실패했습니다.</strong><br>
                                <a href="{{ url_for('main.index') }}" class="text-blue-600 hover:underline">메인 페이지</a>에서 연결 상태를 확인해주세요.
                            </div>
                        </div>
                    </div>
                    {% else %}
                    <h3>등록된 AWS 계정이 없습니다</h3>
                    <p>보안 진단을 시작하려면 먼저 AWS 계정을 연결해주세요.</p>
                    {% endif %}
                    <a href="{{ url_for('connection.index') }}" class="btn btn-primary"> <span>💫</span> AWS 계정 연결하기 </a>
                </div>
                {% endif %}
            </div>

            <!-- 진단 제어 패널 -->
            {% if selected_account %}
            <div class="diagnosis-control-panel" id="controlPanel" style="display: none">
                <div class="panel-header">
                    <h2 class="panel-title">
                        <span class="panel-icon">🔍</span>
                        보안 진단 제어판
                    </h2>
                    <div class="panel-actions">
                        <button class="btn btn-secondary" onclick="testConnection()"><span>🔗</span> 연결 테스트</button>
                        <button class="btn btn-primary" onclick="runAllDiagnosis()"><span>🚀</span> 전체 진단 시작</button>
                    </div>
                </div>

                <!-- 진단 통계 -->
                <div class="diagnosis-stats">
                    <div class="stat-card">
                        <div class="stat-icon">📊</div>
                        <div class="stat-content">
                            <div class="stat-number">41</div>
                            <div class="stat-label">전체 항목</div>
                        </div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon">🔴</div>
                        <div class="stat-content">
                            <div class="stat-number">16</div>
                            <div class="stat-label">상위험</div>
                        </div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon">🟡</div>
                        <div class="stat-content">
                            <div class="stat-number">22</div>
                            <div class="stat-label">중위험</div>
                        </div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon">🟢</div>
                        <div class="stat-content">
                            <div class="stat-number">3</div>
                            <div class="stat-label">저위험</div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- 진단 결과 대시보드 -->
            <div class="diagnosis-results-dashboard" id="resultsDashboard" style="display: none;">
                <h2 class="dashboard-title">
                    <span class="dashboard-icon">📊</span>
                    진단 결과 요약
                </h2>
                
                <div class="results-grid">
                    <!-- 총 진단 항목 -->
                    <div class="result-card total-card">
                        <div class="result-icon">📋</div>
                        <div class="result-content">
                            <div class="result-number" id="totalScanned">0</div>
                            <div class="result-label">진단 완료</div>
                            <div class="result-percentage">전체 41개 중</div>
                        </div>
                    </div>
                    
                    <!-- 취약 항목 -->
                    <div class="result-card vulnerable-card">
                        <div class="result-icon">⚠️</div>
                        <div class="result-content">
                            <div class="result-number" id="vulnerableCount">0</div>
                            <div class="result-label">취약</div>
                            <div class="result-percentage" id="vulnerablePercentage">0%</div>
                        </div>
                    </div>
                    
                    <!-- 안전 항목 -->
                    <div class="result-card safe-card">
                        <div class="result-icon">✅</div>
                        <div class="result-content">
                            <div class="result-number" id="safeCount">0</div>
                            <div class="result-label">안전</div>
                            <div class="result-percentage" id="safePercentage">0%</div>
                        </div>
                    </div>
                    
                    <!-- 위험도별 분포 -->
                    <div class="result-card risk-distribution-card">
                        <div class="distribution-header">
                            <span class="distribution-title">위험도 분포</span>
                        </div>
                        <div class="distribution-content">
                            <div class="risk-item">
                                <span class="risk-label">🔴 상위험</span>
                                <span class="risk-count" id="highRiskCount">0</span>
                            </div>
                            <div class="risk-item">
                                <span class="risk-label">🟡 중위험</span>
                                <span class="risk-count" id="mediumRiskCount">0</span>
                            </div>
                            <div class="risk-item">
                                <span class="risk-label">🟢 저위험</span>
                                <span class="risk-count" id="lowRiskCount">0</span>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- 안전률 바 -->
                <div class="progress-bar-container">
                    <div class="progress-bar-header">
                        <span>전체 안전률</span>
                        <span id="safetyRate">0%</span>
                    </div>
                    <div class="progress-bar-bg">
                        <div class="progress-bar-fill" id="safetyBarFill" style="width: 0%"></div>
                    </div>
                </div>
            </div>
            {% endif %}

            <!-- 진단 항목 섹션 -->
            {% if selected_account and sk_items %}
            <div class="diagnosis-items-section" id="diagnosisItems" style="display: none">
                <h2 class="section-title">
                    <span class="section-icon">📋</span>
                    진단 항목 목록
                </h2>

                {% for category, items in sk_items.items() %}
                <div class="category-section">
                    <div class="category-header">
                        <h3 class="category-title">{{ category }}</h3>
                        <div class="category-meta">
                            <span class="item-count">{{ items|length }}개 항목</span>
                        </div>
                    </div>

                    <div class="items-grid">
                        {% for item in items %}
                        <div class="diagnosis-item {% if not item.implemented %}item-not-implemented{% endif %}" data-item-code="{{ item.code }}" data-category="{{ category }}">
                            <div class="item-header">
                                <div class="item-code">{{ item.code }}</div>
                                <div class="item-severity severity-{{ item.severity }}">{% if item.severity == '상' %}🔴{% elif item.severity == '중' %}🟡{% else %}🟢{% endif %} {{ item.severity }}</div>
                                {% if not item.implemented %}
                                <div class="item-implementation-status">
                                    <span class="badge badge-not-implemented">미구현</span>
                                </div>
                                {% endif %}
                            </div>
                            <div class="item-content">
                                <h4 class="item-name">{{ item.name }}</h4>
                                <p class="item-description">{{ item.description }}</p>
                                {% if not item.implemented %}
                                <p class="item-note">※ 현재 개발 중인 기능입니다.</p>
                                {% endif %}
                            </div>
                            <div class="item-actions">
                                {% if item.implemented %}
                                <button class="btn btn-sm btn-primary" onclick="runSingleDiagnosis('{{ item.code }}')"><span>🔍</span> 진단 실행</button>
                                <div class="item-status" id="status-{{ item.code }}">
                                    <span class="status-badge status-idle">대기</span>
                                </div>
                                {% else %}
                                <button class="btn btn-sm btn-disabled" disabled><span>🚧</span> 개발 중</button>
                                <div class="item-status">
                                    <span class="status-badge status-not-implemented">미구현</span>
                                </div>
                                {% endif %}
                            </div>

                            <!-- 진단 결과 영역 -->
                            {% if item.implemented %}
                            <div class="diagnosis-result" id="result-{{ item.code }}" style="display: none">
                                <!-- 결과가 여기에 동적으로 로드됩니다 -->
                            </div>
                            {% endif %}
                        </div>
                        {% endfor %}
                    </div>
                </div>
                {% endfor %}
            </div>
            {% endif %}

            <!-- 로딩 스피너 템플릿 -->
            <div id="loadingTemplate" style="display: none">
                <div class="diagnosis-loading">
                    <div class="loading-spinner"></div>
                    <div class="loading-text">진단 진행 중...</div>
                </div>
            </div>

            <!-- 결과 템플릿 -->
            <div id="resultTemplate" style="display: none">
                <div class="result-header">
                    <div class="result-status-badge"></div>
                    <div class="result-timestamp"></div>
                </div>
                <div class="result-content">
                    <!-- 결과 내용이 동적으로 삽입됩니다 -->
                </div>
                <div class="result-actions">
                    <button class="btn btn-sm btn-secondary" onclick="rediagnose(this)"><span>🔄</span> 재진단</button>
                </div>
            </div>

            <script>
                let selectedAccountId = null;
                let diagnosisInProgress = false;
                let diagnosisResults = {
                    total: 0,
                    vulnerable: 0,
                    safe: 0,
                    highRisk: 0,
                    mediumRisk: 0,
                    lowRisk: 0
                };

                // 키를 사용자 친화적 이름으로 변환
                function convertKeyToFriendlyName(key) {
                    const keyMap = {
                        'message': '메시지',
                        'summary': '요약',
                        'total_users': '전체 사용자',
                        'admin_users': '관리자 권한 사용자',
                        'test_users': '테스트/임시 계정',
                        'vulnerable_nacls': '취약한 네트워크 ACL',
                        'misconfigured_routes': '잘못된 경로 설정',
                        'insecure_buckets': '보안 설정 부족 S3 버킷',
                        'unencrypted_instances': '암호화되지 않은 인스턴스',
                        'unencrypted_volumes': '암호화되지 않은 볼륨',
                        'unencrypted_clusters': '암호화되지 않은 클러스터',
                        'unprotected_resources': '보호되지 않은 리소스',
                        'policy_violations': '정책 위반 항목',
                        'security_groups': '보안 그룹',
                        'access_keys': '액세스 키',
                        'certificates': '인증서',
                        'trails': '클라우드트레일',
                        'log_groups': '로그 그룹',
                        'backup_vaults': '백업 볼트',
                        'findings': '발견된 항목',
                        'count': '개수',
                        'description': '설명'
                    };
                    return keyMap[key] || key.replace(/_/g, ' ').replace(/\b\w/g, l => l.toUpperCase());
                }

                // 항목 리스트 토글
                function toggleItemsList(button) {
                    const container = button.nextElementSibling;
                    const isCollapsed = container.classList.contains('collapsed');
                    
                    if (isCollapsed) {
                        container.classList.remove('collapsed');
                        button.innerHTML = '접기 ▲';
                    } else {
                        container.classList.add('collapsed');
                        button.innerHTML = '상세보기 ▼';
                    }
                }

                // 계정 선택
                function selectAccount(accountId) {
                    selectedAccountId = accountId;
                    
                    // 레이아웃을 2열로 리셋
                    localStorage.setItem('diagnosisLayout', '2');

                    // 페이지 새로고침으로 서버에서 데이터 받아오기
                    window.location.href = `/diagnosis?account=${accountId}`;
                }

                // 연결 테스트
                async function testConnection() {
                    if (!selectedAccountId) {
                        alert('계정을 선택해주세요.');
                        return;
                    }

                    try {
                        const response = await fetch('/diagnosis/api/test-session', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json'
                            },
                            body: JSON.stringify({
                                account_id: selectedAccountId
                            })
                        });

                        const result = await response.json();

                        if (result.status === 'success') {
                            alert(`✅ 연결 테스트 성공!\n계정 ID: ${result.account_id}\n접근 가능 리전: ${result.regions}개`);
                        } else {
                            alert(`❌ 연결 테스트 실패\n${result.error_message}`);
                        }
                    } catch (error) {
                        alert(`연결 테스트 중 오류가 발생했습니다: ${error.message}`);
                    }
                }

                // 개별 진단 실행
                async function runSingleDiagnosis(itemCode) {
                    if (!selectedAccountId) {
                        alert('계정을 선택해주세요.');
                        return;
                    }

                    const statusElement = document.getElementById(`status-${itemCode}`);
                    const resultElement = document.getElementById(`result-${itemCode}`);

                    // 진행 상태로 변경
                    statusElement.innerHTML = '<span class="status-badge status-running">진행중</span>';
                    resultElement.style.display = 'none';

                    try {
                        const response = await fetch('/diagnosis/api/run', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json'
                            },
                            body: JSON.stringify({
                                account_id: selectedAccountId,
                                item_code: itemCode
                            })
                        });

                        // 응답이 JSON인지 확인
                        const contentType = response.headers.get('content-type');
                        if (!contentType || !contentType.includes('application/json')) {
                            const text = await response.text();
                            console.error('JSON이 아닌 응답:', text);
                            throw new Error(`서버에서 HTML을 반환했습니다. Flask 서버가 올바르게 실행되고 있는지 확인하세요.`);
                        }

                        const result = await response.json();

                        if (result.status === 'success') {
                            statusElement.innerHTML = '<span class="status-badge status-completed">완료</span>';
                            displayDiagnosisResult(itemCode, result);
                        } else {
                            statusElement.innerHTML = '<span class="status-badge status-failed">실패</span>';
                            resultElement.innerHTML = `<div class="error-message">❌ ${result.message}</div>`;
                            resultElement.style.display = 'block';
                        }
                    } catch (error) {
                        statusElement.innerHTML = '<span class="status-badge status-failed">실패</span>';
                        resultElement.innerHTML = `<div class="error-message">❌ 진단 중 오류가 발생했습니다: ${error.message}</div>`;
                        resultElement.style.display = 'block';
                    }
                }

                // 서버 상태 체크
                async function checkServerStatus() {
                    try {
                        const response = await fetch('/diagnosis/api/test-session', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json'
                            },
                            body: JSON.stringify({
                                account_id: 'test'
                            })
                        });
                        return response.headers.get('content-type')?.includes('application/json');
                    } catch (error) {
                        return false;
                    }
                }

                // 전체 진단 실행 (개별 순차 실행으로 변경)
                async function runAllDiagnosis() {
                    if (!selectedAccountId) {
                        alert('계정을 선택해주세요.');
                        return;
                    }

                    if (diagnosisInProgress) {
                        alert('이미 진단이 진행 중입니다.');
                        return;
                    }

                    // 서버 상태 체크
                    const serverOk = await checkServerStatus();
                    if (!serverOk) {
                        alert('⚠️ Flask 서버가 실행되지 않았거나 API 엔드포인트에 접근할 수 없습니다.\n\n다음을 확인해주세요:\n1. Flask 서버가 실행 중인지 확인\n2. python run.py 명령으로 서버 시작\n3. 브라우저 콘솔에서 오류 메시지 확인');
                        return;
                    }

                    diagnosisInProgress = true;
                    
                    // 레이아웃 라디오 버튼 비활성화
                    setLayoutRadioEnabled(false);

                    // 진행 상태 패널 표시
                    showProgressPanel();
                    
                    // 진단 결과 초기화
                    resetDiagnosisResults();
                    
                    // 진단 결과 대시보드 표시
                    document.getElementById('resultsDashboard').style.display = 'block';

                    // 모든 진단 항목을 대기 상태로 변경
                    const allItems = document.querySelectorAll('.diagnosis-item');
                    const itemCodes = Array.from(allItems).map(item => item.dataset.itemCode);

                    // 진단 항목들을 대기 상태로 설정
                    itemCodes.forEach(itemCode => {
                        setItemStatus(itemCode, 'waiting');
                    });

                    let completedCount = 0;
                    let failedCount = 0;
                    const totalItems = itemCodes.length;

                    addDebugLog(`전체 진단 시작 - 총 ${totalItems}개 항목`);
                    updateCurrentStatus('전체 진단 시작 중...');

                    try {
                        // 각 항목을 순차적으로 실행
                        for (let i = 0; i < itemCodes.length; i++) {
                            const itemCode = itemCodes[i];
                            const itemName = getItemNameByCode(itemCode);

                            // 현재 실행 중인 항목 표시
                            setItemStatus(itemCode, 'running');
                            updateCurrentStatus(`[${i + 1}/${totalItems}] ${itemCode} ${itemName} 진단 중...`);
                            addDebugLog(`📋 [${itemCode}] ${itemName} 진단 시작`);

                            // 현재 진단 중인 항목으로 스크롤 이동
                            scrollToCurrentItem(itemCode);

                            try {
                                const result = await runSingleDiagnosisQuiet(itemCode);
                                setItemStatus(itemCode, 'completed');
                                completedCount++;
                                
                                // 진단 결과 업데이트
                                updateDiagnosisResults(result);
                                
                                addDebugLog(`✅ [${itemCode}] 진단 완료`);
                            } catch (error) {
                                setItemStatus(itemCode, 'completed'); // 실패해도 버튼은 복구
                                failedCount++;
                                addDebugLog(`❌ [${itemCode}] 진단 실패: ${error.message}`);
                            }

                            // 진행률 업데이트
                            const progressPercentage = Math.round(((i + 1) / totalItems) * 100);
                            updateProgressStats(progressPercentage, completedCount, failedCount);

                            // 진단 간 잠시 대기 (UI 업데이트를 위해)
                            await new Promise(resolve => setTimeout(resolve, 200));
                        }

                        // 완료 처리
                        updateCurrentStatus(`전체 진단 완료! 성공: ${completedCount}개, 실패: ${failedCount}개`);
                        addDebugLog(`🎉 전체 진단 완료 - 성공: ${completedCount}개, 실패: ${failedCount}개`);

                        // 진단 완료 상태로 변경 (패널은 숨기지 않음)
                        markDiagnosisCompleted(completedCount, failedCount, totalItems);

                        // 전체 진단 완료 후 맨 위로 부드럽게 스크롤
                        setTimeout(() => {
                            window.scrollTo({
                                top: 0,
                                behavior: 'smooth'
                            });
                        }, 1000);

                    } catch (error) {
                        addDebugLog(`❌ 전체 진단 중 오류 발생: ${error.message}`);
                        updateCurrentStatus(`진단 중 오류 발생: ${error.message}`);
                    } finally {
                        diagnosisInProgress = false;
                        // 레이아웃 라디오 버튼 다시 활성화
                        setLayoutRadioEnabled(true);
                    }
                }

                // 진단 결과 표시
                function displayDiagnosisResult(itemCode, result) {
                    const resultElement = document.getElementById(`result-${itemCode}`);
                    const diagnosisResult = result.result;

                    let resultHTML = '<div class="result-summary">';

                    if (diagnosisResult.status === 'success') {
                        resultHTML += `<div class="result-item">
                            <strong>위험도:</strong> <span class="risk-level risk-${diagnosisResult.risk_level}">${diagnosisResult.risk_level}</span>
                        </div>`;

                        if (diagnosisResult.has_issues) {
                            resultHTML += '<div class="result-item"><strong>⚠️ 보안 이슈가 발견되었습니다</strong></div>';
                        } else {
                            resultHTML += '<div class="result-item"><strong>✅ 보안 이슈가 발견되지 않았습니다</strong></div>';
                        }

                        // 요약 정보 표시
                        if (diagnosisResult.summary) {
                            resultHTML += `<div class="result-item"><strong>summary:</strong> ${diagnosisResult.summary}</div>`;
                        }

                        // 상세 정보가 있으면 행 형태로 표시
                        if (diagnosisResult.details && typeof diagnosisResult.details === 'object') {
                            resultHTML += '<div class="result-details">';
                            resultHTML += '<div class="details-rows">';
                            
                            // 빈 값 필터링 함수
                            function hasValidContent(value) {
                                if (value === null || value === undefined || value === '') return false;
                                if (typeof value === 'object' && Object.keys(value).length === 0) return false;
                                if (Array.isArray(value) && value.length === 0) return false;
                                if (typeof value === 'object' && value.count === 0) return false;
                                return true;
                            }
                            
                            Object.entries(diagnosisResult.details).forEach(([key, value]) => {
                                // 빈 값은 표시하지 않음
                                if (!hasValidContent(value)) return;
                                
                                // 행 시작
                                resultHTML += '<div class="detail-row">';
                                
                                // 키를 사용자 친화적으로 변환
                                const friendlyKey = convertKeyToFriendlyName(key);
                                resultHTML += `<div class="row-label">${friendlyKey}</div>`;
                                
                                // 값을 적절히 포맷팅
                                resultHTML += '<div class="row-content">';
                                
                                if (typeof value === 'object' && value !== null) {
                                    // 카운트가 있는 경우
                                    if (value.count !== undefined) {
                                        resultHTML += `<span class="count-badge">${value.count}건</span>`;
                                    }
                                    
                                    // 요약 정보
                                    if (value.summary) {
                                        resultHTML += `<div class="summary-text">${value.summary}</div>`;
                                    }
                                    
                                    // 설명
                                    if (value.description) {
                                        resultHTML += `<div class="description-text">${value.description}</div>`;
                                    }
                                    
                                    // 사용자 리스트
                                    if (value.users && Array.isArray(value.users)) {
                                        resultHTML += '<div class="users-container">';
                                        value.users.forEach(user => {
                                            resultHTML += `<span class="user-tag">${user}</span>`;
                                        });
                                        resultHTML += '</div>';
                                    }
                                    
                                    // 배열 데이터 처리 (정책, 규칙 등)
                                    if (Array.isArray(value) && value.length > 0) {
                                        if (value.length <= 3) {
                                            // 3개 이하면 모두 표시
                                            resultHTML += '<div class="items-container">';
                                            value.forEach(item => {
                                                if (typeof item === 'string') {
                                                    resultHTML += `<div class="item-simple">${item}</div>`;
                                                } else if (typeof item === 'object' && item.description) {
                                                    resultHTML += `<div class="item-description">${item.description}</div>`;
                                                }
                                            });
                                            resultHTML += '</div>';
                                        } else {
                                            // 3개 초과면 요약 + 토글
                                            resultHTML += `<div class="items-summary">${value.length}개 항목 발견</div>`;
                                            resultHTML += `<button class="toggle-items-btn" onclick="toggleItemsList(this)">상세보기 ▼</button>`;
                                            resultHTML += '<div class="items-container collapsed">';
                                            value.forEach(item => {
                                                if (typeof item === 'string') {
                                                    resultHTML += `<div class="item-simple">${item}</div>`;
                                                } else if (typeof item === 'object' && item.description) {
                                                    resultHTML += `<div class="item-description">${item.description}</div>`;
                                                }
                                            });
                                            resultHTML += '</div>';
                                        }
                                    }
                                } else {
                                    // 단순 값
                                    resultHTML += `<span class="simple-value">${value}</span>`;
                                }
                                
                                resultHTML += '</div>'; // row-content 종료
                                resultHTML += '</div>'; // detail-row 종료
                            });
                            
                            resultHTML += '</div>'; // details-rows 종료
                            resultHTML += '</div>'; // result-details 종료
                        }

                        // 자동 조치 옵션 표시
                        if (diagnosisResult.fix_options && Array.isArray(diagnosisResult.fix_options)) {
                            resultHTML += '<div class="fix-options">';
                            resultHTML += '<strong>자동 조치 옵션:</strong>';
                            diagnosisResult.fix_options.forEach((option, index) => {
                                resultHTML += `
                                    <div class="fix-option">
                                        <div class="fix-option-header">
                                            <h4>${option.title}</h4>
                                            <p>${option.description}</p>
                                        </div>
                                        <div class="fix-option-items">
                                            ${option.items.map(item => `
                                                <label class="fix-item">
                                                    <input type="checkbox" value="${item.id}" data-option-id="${option.id}" checked>
                                                    <span>${item.name} - ${item.description}</span>
                                                </label>
                                            `).join('')}
                                        </div>
                                        <button class="btn btn-warning btn-fix" onclick="executeFix('${itemCode}', '${option.id}')">
                                            <span>⚡</span> ${option.title} 실행
                                        </button>
                                    </div>
                                `;
                            });
                            resultHTML += '</div>';
                        }

                        // 수동 조치 가이드 표시
                        if (diagnosisResult.manual_guide) {
                            const guide = diagnosisResult.manual_guide;
                            const toggleId = `manual-guide-${itemCode.replace('.', '-')}`;
                            
                            resultHTML += '<div class="manual-guide-box">';
                            resultHTML += `<div class="manual-guide-header" onclick="toggleManualGuide('${toggleId}')">
                                <div class="manual-guide-title-section">
                                    <h4>📋 ${guide.title}</h4>
                                    <p class="manual-guide-description">${guide.description}</p>
                                </div>
                                <button class="manual-guide-toggle-btn" id="toggle-btn-${toggleId}">
                                    <span class="toggle-icon">▼</span>
                                </button>
                            </div>`;

                            resultHTML += `<div class="manual-guide-content" id="${toggleId}" style="display: none;">`;
                            if (guide.steps && Array.isArray(guide.steps)) {
                                resultHTML += '<div class="manual-guide-steps">';
                                guide.steps.forEach((step, index) => {
                                    let stepClass = 'manual-step';
                                    if (step.type === 'warning') stepClass += ' step-warning';
                                    else if (step.type === 'danger') stepClass += ' step-danger';
                                    else if (step.type === 'info') stepClass += ' step-info';
                                    else if (step.type === 'step') stepClass += ' step-action';
                                    else if (step.type === 'commands') stepClass += ' step-commands';

                                    resultHTML += `<div class="${stepClass}">`;
                                    resultHTML += `<div class="step-title">${step.title}</div>`;

                                    if (step.type === 'commands' && Array.isArray(step.content)) {
                                        resultHTML += '<div class="step-content commands-content">';
                                        
                                        // 전체 코드 블록을 하나로 묶기
                                        let fullCodeBlock = '';
                                        let hasValidCommands = false;
                                        
                                        step.content.forEach(command => {
                                            // 빈 문자열이거나 공백만 있는 경우 줄바꿈 추가
                                            if (!command || command.trim() === '') {
                                                fullCodeBlock += '\n';
                                            } else {
                                                fullCodeBlock += command + '\n';
                                                hasValidCommands = true;
                                            }
                                        });
                                        
                                        // 유효한 명령어가 있을 때만 코드 블록 생성
                                        if (hasValidCommands) {
                                            // 마지막 줄바꿈 제거
                                            fullCodeBlock = fullCodeBlock.trim();
                                            
                                            // HTML과 JavaScript에서 안전하게 사용하기 위해 이스케이프 처리
                                            const escapedCode = fullCodeBlock.replace(/</g, '&lt;').replace(/>/g, '&gt;').replace(/"/g, '&quot;');
                                            const safeCode = fullCodeBlock.replace(/'/g, "\\'").replace(/"/g, '\\"').replace(/\n/g, '\\n');
                                            
                                            resultHTML += `<div class="unified-code-block">
                                                <pre class="code-content"><code>${escapedCode}</code></pre>
                                                <button class="btn btn-copy-all" onclick="copyToClipboard('${safeCode}')">
                                                    📋 전체 복사
                                                </button>
                                            </div>`;
                                        }
                                        
                                        resultHTML += '</div>';
                                    } else {
                                        resultHTML += `<div class="step-content">${step.content}</div>`;
                                    }
                                    resultHTML += '</div>';
                                });
                                resultHTML += '</div>';
                            }
                            resultHTML += '</div>'; // manual-guide-content 닫기
                            resultHTML += '</div>'; // manual-guide-box 닫기
                        }
                    } else {
                        resultHTML += `<div class="error-message">❌ ${diagnosisResult.error_message}</div>`;
                    }

                    resultHTML += '</div>';

                    resultElement.innerHTML = resultHTML;
                    resultElement.style.display = 'block';
                }


                // 자동 조치 실행
                async function executeFix(itemCode, optionId) {
                    if (!selectedAccountId) {
                        alert('계정을 선택해주세요.');
                        return;
                    }

                    // 선택된 항목들 수집
                    const checkboxes = document.querySelectorAll(`input[data-option-id="${optionId}"]:checked`);
                    if (checkboxes.length === 0) {
                        alert('조치할 항목을 선택해주세요.');
                        return;
                    }

                    const selectedItems = {};
                    selectedItems[optionId] = Array.from(checkboxes).map(cb => ({
                        id: cb.value,
                        name: cb.value,
                        description: cb.parentElement.textContent.trim()
                    }));

                    // 확인 메시지
                    const itemCount = checkboxes.length;
                    const confirmMessage = `정말로 ${itemCount}개 항목에 대해 자동 조치를 실행하시겠습니까?\n\n⚠️ 이 작업은 되돌릴 수 없습니다.`;

                    if (!confirm(confirmMessage)) {
                        return;
                    }

                    try {
                        // 실행 버튼 비활성화
                        const executeButton = event.target;
                        const originalText = executeButton.innerHTML;
                        executeButton.disabled = true;
                        executeButton.innerHTML = '<span>⏳</span> 실행 중...';

                        const response = await fetch('/diagnosis/api/fix', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json'
                            },
                            body: JSON.stringify({
                                account_id: selectedAccountId,
                                item_code: itemCode,
                                selected_items: selectedItems
                            })
                        });

                        const result = await response.json();

                        if (result.status === 'success') {
                            let successCount = 0;
                            let failCount = 0;
                            let message = '자동 조치 실행 결과:\n\n';

                            result.results.forEach(res => {
                                if (res.status === 'success') {
                                    successCount++;
                                    message += `✅ ${res.message}\n`;
                                } else {
                                    failCount++;
                                    message += `❌ ${res.message}\n`;
                                }
                            });

                            message += `\n성공: ${successCount}개, 실패: ${failCount}개`;
                            alert(message);

                            // 성공했으면 해당 항목 재진단
                            if (successCount > 0) {
                                setTimeout(() => {
                                    runSingleDiagnosis(itemCode);
                                }, 1000);
                            }
                        } else {
                            alert(`❌ 자동 조치 실패\n${result.message}`);
                        }

                        // 버튼 복구
                        executeButton.disabled = false;
                        executeButton.innerHTML = originalText;

                    } catch (error) {
                        alert(`자동 조치 실행 중 오류가 발생했습니다: ${error.message}`);

                        // 버튼 복구
                        const executeButton = event.target;
                        executeButton.disabled = false;
                        executeButton.innerHTML = originalText;
                    }
                }

                // 재진단
                function rediagnose(button) {
                    const itemElement = button.closest('.diagnosis-item');
                    const itemCode = itemElement.dataset.itemCode;
                    runSingleDiagnosis(itemCode);
                }

                // 진행 상태 사이드바 표시/숨기기
                function showProgressPanel() {
                    document.getElementById('progressSidebar').style.display = 'block';
                    resetProgressStats();
                }

                function hideProgressPanel() {
                    document.getElementById('progressSidebar').style.display = 'none';
                }

                // 진단 완료 상태로 변경
                function markDiagnosisCompleted(completedCount, failedCount, totalItems) {
                    // 사이드바 제목을 완료 상태로 변경
                    const sidebarTitle = document.querySelector('#progressSidebar h4');
                    if (sidebarTitle) {
                        sidebarTitle.innerHTML = `
                            <span class="text-lg mr-2">✅</span>
                            진단 완료
                        `;
                    }

                    // 완료 요약 정보 추가
                    const completionRate = Math.round((completedCount / totalItems) * 100);
                    addDebugLog(`📊 완료율: ${completionRate}% (${completedCount}/${totalItems})`);

                    // 현재 상태를 완료 상태로 고정
                    updateCurrentStatus(`진단 완료 - 성공률: ${completionRate}%`);

                    // 사이드바 배경색을 완료 상태로 변경
                    const progressSidebar = document.getElementById('progressSidebar');
                    if (progressSidebar) {
                        progressSidebar.style.borderLeft = '4px solid #10b981';
                        progressSidebar.style.backgroundColor = '#f0fdf4';
                    }
                }

                // 진행 상태 초기화
                function resetProgressStats() {
                    updateProgressStats(0, 0, 0);
                    updateCurrentStatus('진단 준비 중...');
                    clearDebugLog();
                    addDebugLog('진단 시작 준비 중...');

                    // 사이드바 초기 상태로 리셋
                    const sidebarTitle = document.querySelector('#progressSidebar h4');
                    if (sidebarTitle) {
                        sidebarTitle.innerHTML = `
                            <span class="text-lg mr-2">🚀</span>
                            진단 진행 상황
                        `;
                    }

                    // 사이드바 배경색 초기화
                    const progressSidebar = document.getElementById('progressSidebar');
                    if (progressSidebar) {
                        progressSidebar.style.borderLeft = '';
                        progressSidebar.style.backgroundColor = '';
                    }
                }

                // 진행 상태 업데이트
                function updateProgressStats(percentage, completed, failed) {
                    document.getElementById('progressPercentageValue').textContent = `${percentage}%`;
                    document.getElementById('completedCountValue').textContent = completed;
                    document.getElementById('failedCountValue').textContent = failed;
                    document.getElementById('progressFillBar').style.width = `${percentage}%`;
                }

                // 현재 상태 메시지 업데이트
                function updateCurrentStatus(message) {
                    document.getElementById('currentStatusText').textContent = message;
                }

                // 디버그 로그 추가
                function addDebugLog(message) {
                    const logContainer = document.getElementById('debugLogList');
                    const logEntry = document.createElement('div');

                    // 메시지 타입에 따라 색상 결정
                    let colorClass = 'text-gray-300'; // 기본
                    if (message.includes('✅') || message.includes('완료')) {
                        colorClass = 'text-green-400';
                    } else if (message.includes('❌') || message.includes('실패')) {
                        colorClass = 'text-red-400';
                    } else if (message.includes('📋') || message.includes('시작')) {
                        colorClass = 'text-blue-400';
                    } else if (message.includes('🎉')) {
                        colorClass = 'text-yellow-400';
                    }

                    logEntry.className = `${colorClass} font-mono mb-1 text-xs`;
                    logEntry.textContent = `[${new Date().toLocaleTimeString()}] ${message}`;
                    logContainer.appendChild(logEntry);

                    // 스크롤을 맨 아래로
                    logContainer.scrollTop = logContainer.scrollHeight;

                    // 로그 항목이 너무 많으면 오래된 것 제거
                    const logEntries = logContainer.children;
                    if (logEntries.length > 20) {
                        logContainer.removeChild(logEntries[0]);
                    }
                }

                // 디버그 로그 초기화
                function clearDebugLog() {
                    const logContainer = document.getElementById('debugLogList');
                    logContainer.innerHTML = '<div class="text-green-400 font-mono">진단 시작 준비 중...</div>';
                }

                // 항목 상태 설정
                function setItemStatus(itemCode, status) {
                    const itemElement = document.querySelector(`[data-item-code="${itemCode}"]`);
                    if (!itemElement) {
                        console.warn(`항목을 찾을 수 없습니다: ${itemCode}`);
                        return;
                    }

                    const actionButton = itemElement.querySelector('.item-actions .btn:not(.btn-disabled)');
                    if (!actionButton) {
                        console.warn(`진단 버튼을 찾을 수 없습니다: ${itemCode}`);
                        return;
                    }

                    const resultElement = document.getElementById(`result-${itemCode}`);

                    if (status === 'waiting') {
                        actionButton.innerHTML = '<span>⏳</span> 대기 중';
                        actionButton.disabled = true;
                        if (resultElement) {
                            resultElement.style.display = 'none';
                        }
                    } else if (status === 'running') {
                        actionButton.innerHTML = '<span>🔄</span> 실행 중';
                        actionButton.disabled = true;
                    } else if (status === 'completed') {
                        actionButton.innerHTML = '<span>🎯</span> 진단 실행';
                        actionButton.disabled = false;
                    }
                }

                // 항목 코드로 이름 조회
                function getItemNameByCode(itemCode) {
                    const itemElement = document.querySelector(`[data-item-code="${itemCode}"]`);
                    if (!itemElement) return itemCode;

                    const titleElement = itemElement.querySelector('.item-name');
                    return titleElement ? titleElement.textContent.trim() : itemCode;
                }

                // 현재 진단 중인 항목으로 스크롤 이동
                function scrollToCurrentItem(itemCode) {
                    const itemElement = document.querySelector(`[data-item-code="${itemCode}"]`);
                    if (itemElement) {
                        // 부드럽게 스크롤하면서 항목을 화면 중앙에 배치
                        itemElement.scrollIntoView({
                            behavior: 'smooth',
                            block: 'center',
                            inline: 'nearest'
                        });

                        // 현재 진단 중인 항목 강조 효과
                        highlightCurrentItem(itemCode);
                    }
                }

                // 현재 진단 중인 항목 강조 효과
                function highlightCurrentItem(itemCode) {
                    // 기존 강조 효과 제거
                    document.querySelectorAll('.diagnosis-item').forEach(item => {
                        item.classList.remove('current-diagnosing');
                    });

                    // 현재 항목에 강조 효과 추가
                    const currentItem = document.querySelector(`[data-item-code="${itemCode}"]`);
                    if (currentItem) {
                        currentItem.classList.add('current-diagnosing');

                        // 3초 후 강조 효과 제거 (진단이 완료되면)
                        setTimeout(() => {
                            currentItem.classList.remove('current-diagnosing');
                        }, 3000);
                    }
                }

                // 조용한 단일 진단 (로그 없이)
                async function runSingleDiagnosisQuiet(itemCode) {
                    const response = await fetch('/diagnosis/api/run', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            account_id: selectedAccountId,
                            item_code: itemCode
                        })
                    });

                    // 응답이 JSON인지 확인
                    const contentType = response.headers.get('content-type');
                    if (!contentType || !contentType.includes('application/json')) {
                        const text = await response.text();
                        console.error('JSON이 아닌 응답:', text);
                        throw new Error(`서버에서 HTML을 반환했습니다. Flask 서버가 올바르게 실행되고 있는지 확인하세요.`);
                    }

                    const result = await response.json();

                    if (result.status === 'success') {
                        displayDiagnosisResult(itemCode, result);
                        return result;  // 결과 반환 추가
                    } else {
                        throw new Error(result.message || '진단 실패');
                    }
                }

                // 진단 결과 초기화
                function resetDiagnosisResults() {
                    diagnosisResults = {
                        total: 0,
                        vulnerable: 0,
                        safe: 0,
                        highRisk: 0,
                        mediumRisk: 0,
                        lowRisk: 0
                    };
                    updateDashboard();
                }

                // 진단 결과 업데이트
                function updateDiagnosisResults(result) {
                    if (!result || !result.result) return;
                    
                    console.log('진단 결과 업데이트:', result);
                    
                    diagnosisResults.total++;
                    
                    // 취약/안전 판단
                    if (result.result.has_issues) {
                        diagnosisResults.vulnerable++;
                    } else {
                        diagnosisResults.safe++;
                    }
                    
                    // 위험도별 분류
                    const riskLevel = result.result.risk_level;
                    console.log('위험도 레벨:', riskLevel);
                    
                    if (riskLevel === 'high') {
                        diagnosisResults.highRisk++;
                    } else if (riskLevel === 'medium') {
                        diagnosisResults.mediumRisk++;
                    } else if (riskLevel === 'low') {
                        diagnosisResults.lowRisk++;
                    } else {
                        console.warn('알 수 없는 위험도 레벨:', riskLevel);
                    }
                    
                    console.log('현재 진단 결과 상태:', diagnosisResults);
                    updateDashboard();
                }

                // 대시보드 UI 업데이트
                function updateDashboard() {
                    // 총 진단 항목
                    document.getElementById('totalScanned').textContent = diagnosisResults.total;
                    
                    // 취약 항목
                    document.getElementById('vulnerableCount').textContent = diagnosisResults.vulnerable;
                    const vulnerablePercentage = diagnosisResults.total > 0 
                        ? Math.round((diagnosisResults.vulnerable / diagnosisResults.total) * 100) 
                        : 0;
                    document.getElementById('vulnerablePercentage').textContent = `${vulnerablePercentage}%`;
                    
                    // 안전 항목
                    document.getElementById('safeCount').textContent = diagnosisResults.safe;
                    const safePercentage = diagnosisResults.total > 0 
                        ? Math.round((diagnosisResults.safe / diagnosisResults.total) * 100) 
                        : 0;
                    document.getElementById('safePercentage').textContent = `${safePercentage}%`;
                    
                    // 위험도별 분포
                    document.getElementById('highRiskCount').textContent = diagnosisResults.highRisk;
                    document.getElementById('mediumRiskCount').textContent = diagnosisResults.mediumRisk;
                    document.getElementById('lowRiskCount').textContent = diagnosisResults.lowRisk;
                    
                    // 안전률 바
                    const safetyRate = diagnosisResults.total > 0 
                        ? Math.round((diagnosisResults.safe / diagnosisResults.total) * 100) 
                        : 0;
                    document.getElementById('safetyRate').textContent = `${safetyRate}%`;
                    document.getElementById('safetyBarFill').style.width = `${safetyRate}%`;
                }

                // 클립보드 복사
                async function copyToClipboard(text) {
                    try {
                        await navigator.clipboard.writeText(text);
                        // 임시 알림 표시 (선택사항)
                        const button = event.target;
                        const originalText = button.textContent;
                        button.textContent = '✅';
                        setTimeout(() => {
                            button.textContent = originalText;
                        }, 1000);
                    } catch (err) {
                        // 클립보드 API가 지원되지 않는 경우 fallback
                        const textArea = document.createElement('textarea');
                        textArea.value = text;
                        document.body.appendChild(textArea);
                        textArea.select();
                        try {
                            document.execCommand('copy');
                            const button = event.target;
                            const originalText = button.textContent;
                            button.textContent = '✅';
                            setTimeout(() => {
                                button.textContent = originalText;
                            }, 1000);
                        } catch (err) {
                            alert('클립보드 복사에 실패했습니다.');
                        }
                        document.body.removeChild(textArea);
                    }
                }

                // 레이아웃 변경 함수
                function changeLayout(columns) {
                    const itemsGrid = document.querySelectorAll('.items-grid');
                    
                    itemsGrid.forEach(grid => {
                        if (columns === 1) {
                            grid.classList.remove('grid', 'grid-cols-1', 'md:grid-cols-2', 'gap-4');
                            grid.classList.add('space-y-4');
                        } else {
                            grid.classList.remove('space-y-4');
                            grid.classList.add('grid', 'grid-cols-1', 'md:grid-cols-2', 'gap-4');
                        }
                    });
                    
                    // 로컬 스토리지에 저장
                    localStorage.setItem('diagnosisLayout', columns.toString());
                }

                // 라디오 버튼 활성화/비활성화
                function setLayoutRadioEnabled(enabled) {
                    const radios = document.querySelectorAll('input[name="layout"]');
                    const labels = document.querySelectorAll('#layoutRadioGroup label');
                    
                    radios.forEach(radio => {
                        radio.disabled = !enabled;
                    });
                    
                    labels.forEach(label => {
                        if (enabled) {
                            label.classList.remove('opacity-50', 'cursor-not-allowed');
                            label.classList.add('cursor-pointer');
                        } else {
                            label.classList.add('opacity-50', 'cursor-not-allowed');
                            label.classList.remove('cursor-pointer');
                        }
                    });
                }

                // 페이지 로드 시 선택된 계정이 있으면 자동 선택
                document.addEventListener('DOMContentLoaded', function() {
                    {% if selected_account %}
                    selectedAccountId = '{{ selected_account.account_id }}';

                    // 제어판과 진단 항목이 존재하면 표시
                    const controlPanel = document.getElementById('controlPanel');
                    const diagnosisItems = document.getElementById('diagnosisItems');

                    if (controlPanel) {
                        controlPanel.style.display = 'block';
                    }
                    if (diagnosisItems) {
                        diagnosisItems.style.display = 'block';
                    }
                    {% endif %}
                    
                    // 저장된 레이아웃 설정 불러오기
                    const savedLayout = localStorage.getItem('diagnosisLayout');
                    if (savedLayout) {
                        const radio = document.getElementById(savedLayout === '1' ? 'layout1Col' : 'layout2Col');
                        if (radio) {
                            radio.checked = true;
                            changeLayout(parseInt(savedLayout));
                        }
                    }
                    
                    // 라디오 버튼 이벤트 리스너
                    const layoutRadios = document.querySelectorAll('input[name="layout"]');
                    layoutRadios.forEach(radio => {
                        radio.addEventListener('change', function() {
                            changeLayout(parseInt(this.value));
                        });
                    });
                });

                // 수동 조치 가이드 토글 함수
                function toggleManualGuide(toggleId) {
                    const content = document.getElementById(toggleId);
                    const toggleBtn = document.getElementById(`toggle-btn-${toggleId}`);
                    const toggleIcon = toggleBtn.querySelector('.toggle-icon');
                    
                    if (content.style.display === 'none' || content.style.display === '') {
                        content.style.display = 'block';
                        toggleIcon.textContent = '▲';
                        toggleBtn.setAttribute('aria-expanded', 'true');
                    } else {
                        content.style.display = 'none';
                        toggleIcon.textContent = '▼';
                        toggleBtn.setAttribute('aria-expanded', 'false');
                    }
                }
            </script>
            {% endblock %} {% block extra_css %}
            <link rel="stylesheet" href="{{ url_for('static', filename='css/pages/diagnosis.css') }}" />
            {% endblock %}
        </div>
    </div>
</div>
