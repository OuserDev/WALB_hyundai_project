{% extends "base.html" %}
{% set page_title = "보안 진단" %}

{% block title %}{{ page_title }}{% endblock %}

{% block content %}
<div class="diagnosis-container">
    <!-- 히어로 헤더 -->
    <div class="hero-header">
        <div class="floating-elements">
            <div class="floating-circle circle-1"></div>
            <div class="floating-circle circle-2"></div>
            <div class="floating-circle circle-3"></div>
        </div>
        <div class="hero-content">
            <div class="hero-icon">🔍</div>
            <div class="hero-text">
                <h1 class="hero-title">AWS 클라우드 보안 진단</h1>
                <p class="hero-subtitle">SK Shieldus 2024 가이드라인 기준 41개 항목 자동 점검</p>
            </div>
        </div>
    </div>

    <!-- 계정 선택 섹션 -->
    <div class="account-selection-section">
        <h2 class="section-title">
            <span class="section-icon">☁️</span>
            연결된 AWS 계정
        </h2>
        
        {% if accounts %}
            <div class="accounts-grid">
                {% for account in accounts %}
                <div class="account-card {% if selected_account and selected_account.account_id == account.account_id %}selected{% endif %}" 
                     data-account-id="{{ account.account_id }}"
                     onclick="selectAccount('{{ account.account_id }}')">
                    <div class="account-header">
                        <h3 class="account-name">{{ account.cloud_name }}</h3>
                        <div class="account-type-badge">
                            {% if account.connection_type == 'role' %}
                                <span class="badge badge-role">Role</span>
                            {% else %}
                                <span class="badge badge-key">Key</span>
                            {% endif %}
                        </div>
                    </div>
                    <div class="account-details">
                        <div class="account-detail">
                            <span class="detail-label">계정 ID</span>
                            <span class="detail-value">{{ account.account_id }}</span>
                        </div>
                        <div class="account-detail">
                            <span class="detail-label">리전</span>
                            <span class="detail-value">{{ account.primary_region }}</span>
                        </div>
                    </div>
                </div>
                {% endfor %}
            </div>
        {% else %}
            <div class="empty-state">
                <div class="empty-icon">📋</div>
                <h3>등록된 AWS 계정이 없습니다</h3>
                <p>보안 진단을 시작하려면 먼저 AWS 계정을 연결해주세요.</p>
                <a href="{{ url_for('connection.index') }}" class="btn btn-primary">
                    <span>💫</span> AWS 계정 연결하기
                </a>
            </div>
        {% endif %}
    </div>

    <!-- 진단 제어 패널 -->
    {% if selected_account %}
    <div class="diagnosis-control-panel" id="controlPanel" style="display: none;">
        <div class="panel-header">
            <h2 class="panel-title">
                <span class="panel-icon">🔍</span>
                보안 진단 제어판
            </h2>
            <div class="panel-actions">
                <button class="btn btn-secondary" onclick="testConnection()">
                    <span>🔗</span> 연결 테스트
                </button>
                <button class="btn btn-primary" onclick="runAllDiagnosis()">
                    <span>🚀</span> 전체 진단 시작
                </button>
            </div>
        </div>
        
        <!-- 진단 통계 -->
        <div class="diagnosis-stats">
            <div class="stat-card">
                <div class="stat-icon">📊</div>
                <div class="stat-content">
                    <div class="stat-number">41</div>
                    <div class="stat-label">전체 항목</div>
                </div>
            </div>
            <div class="stat-card">
                <div class="stat-icon">🔴</div>
                <div class="stat-content">
                    <div class="stat-number">16</div>
                    <div class="stat-label">상위험</div>
                </div>
            </div>
            <div class="stat-card">
                <div class="stat-icon">🟡</div>
                <div class="stat-content">
                    <div class="stat-number">22</div>
                    <div class="stat-label">중위험</div>
                </div>
            </div>
            <div class="stat-card">
                <div class="stat-icon">🟢</div>
                <div class="stat-content">
                    <div class="stat-number">3</div>
                    <div class="stat-label">저위험</div>
                </div>
            </div>
        </div>
    </div>
    {% endif %}

    <!-- 진단 항목 섹션 -->
    {% if selected_account and sk_items %}
    <div class="diagnosis-items-section" id="diagnosisItems" style="display: none;">
        <h2 class="section-title">
            <span class="section-icon">📋</span>
            진단 항목 목록
        </h2>
        
        {% for category, items in sk_items.items() %}
        <div class="category-section">
            <div class="category-header">
                <h3 class="category-title">{{ category }}</h3>
                <div class="category-meta">
                    <span class="item-count">{{ items|length }}개 항목</span>
                    <button class="btn btn-sm btn-outline" onclick="runCategoryDiagnosis('{{ category }}')">
                        <span>🎯</span> 카테고리 진단
                    </button>
                </div>
            </div>
            
            <div class="items-grid">
                {% for item in items %}
                <div class="diagnosis-item {% if not item.implemented %}item-not-implemented{% endif %}" data-item-code="{{ item.code }}" data-category="{{ category }}">
                    <div class="item-header">
                        <div class="item-code">{{ item.code }}</div>
                        <div class="item-severity severity-{{ item.severity }}">
                            {% if item.severity == '상' %}🔴{% elif item.severity == '중' %}🟡{% else %}🟢{% endif %}
                            {{ item.severity }}
                        </div>
                        {% if not item.implemented %}
                        <div class="item-implementation-status">
                            <span class="badge badge-not-implemented">미구현</span>
                        </div>
                        {% endif %}
                    </div>
                    <div class="item-content">
                        <h4 class="item-name">{{ item.name }}</h4>
                        <p class="item-description">{{ item.description }}</p>
                        {% if not item.implemented %}
                        <p class="item-note">※ 현재 개발 중인 기능입니다.</p>
                        {% endif %}
                    </div>
                    <div class="item-actions">
                        {% if item.implemented %}
                        <button class="btn btn-sm btn-primary" onclick="runSingleDiagnosis('{{ item.code }}')">
                            <span>🔍</span> 진단 실행
                        </button>
                        <div class="item-status" id="status-{{ item.code }}">
                            <span class="status-badge status-idle">대기</span>
                        </div>
                        {% else %}
                        <button class="btn btn-sm btn-disabled" disabled>
                            <span>🚧</span> 개발 중
                        </button>
                        <div class="item-status">
                            <span class="status-badge status-not-implemented">미구현</span>
                        </div>
                        {% endif %}
                    </div>
                    
                    <!-- 진단 결과 영역 -->
                    {% if item.implemented %}
                    <div class="diagnosis-result" id="result-{{ item.code }}" style="display: none;">
                        <!-- 결과가 여기에 동적으로 로드됩니다 -->
                    </div>
                    {% endif %}
                </div>
                {% endfor %}
            </div>
        </div>
        {% endfor %}
    </div>
    {% endif %}

</div>

<!-- 로딩 스피너 템플릿 -->
<div id="loadingTemplate" style="display: none;">
    <div class="diagnosis-loading">
        <div class="loading-spinner"></div>
        <div class="loading-text">진단 진행 중...</div>
    </div>
</div>

<!-- 결과 템플릿 -->
<div id="resultTemplate" style="display: none;">
    <div class="result-header">
        <div class="result-status-badge"></div>
        <div class="result-timestamp"></div>
    </div>
    <div class="result-content">
        <!-- 결과 내용이 동적으로 삽입됩니다 -->
    </div>
    <div class="result-actions">
        <button class="btn btn-sm btn-secondary" onclick="rediagnose(this)">
            <span>🔄</span> 재진단
        </button>
    </div>
</div>

<script>
let selectedAccountId = null;
let diagnosisInProgress = false;

// 계정 선택
function selectAccount(accountId) {
    selectedAccountId = accountId;
    
    // 페이지 새로고침으로 서버에서 데이터 받아오기
    window.location.href = `/diagnosis?account=${accountId}`;
}

// 연결 테스트
async function testConnection() {
    if (!selectedAccountId) {
        alert('계정을 선택해주세요.');
        return;
    }
    
    try {
        const response = await fetch('/diagnosis/api/test-session', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                account_id: selectedAccountId
            })
        });
        
        const result = await response.json();
        
        if (result.status === 'success') {
            alert(`✅ 연결 테스트 성공!\n계정 ID: ${result.account_id}\n접근 가능 리전: ${result.regions}개`);
        } else {
            alert(`❌ 연결 테스트 실패\n${result.error_message}`);
        }
    } catch (error) {
        alert(`연결 테스트 중 오류가 발생했습니다: ${error.message}`);
    }
}

// 개별 진단 실행
async function runSingleDiagnosis(itemCode) {
    if (!selectedAccountId) {
        alert('계정을 선택해주세요.');
        return;
    }
    
    const statusElement = document.getElementById(`status-${itemCode}`);
    const resultElement = document.getElementById(`result-${itemCode}`);
    
    // 진행 상태로 변경
    statusElement.innerHTML = '<span class="status-badge status-running">진행중</span>';
    resultElement.style.display = 'none';
    
    try {
        const response = await fetch('/diagnosis/api/run', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                account_id: selectedAccountId,
                item_code: itemCode
            })
        });
        
        // 응답이 JSON인지 확인
        const contentType = response.headers.get('content-type');
        if (!contentType || !contentType.includes('application/json')) {
            const text = await response.text();
            console.error('JSON이 아닌 응답:', text);
            throw new Error(`서버에서 HTML을 반환했습니다. Flask 서버가 올바르게 실행되고 있는지 확인하세요.`);
        }
        
        const result = await response.json();
        
        if (result.status === 'success') {
            statusElement.innerHTML = '<span class="status-badge status-completed">완료</span>';
            displayDiagnosisResult(itemCode, result);
        } else {
            statusElement.innerHTML = '<span class="status-badge status-failed">실패</span>';
            resultElement.innerHTML = `<div class="error-message">❌ ${result.message}</div>`;
            resultElement.style.display = 'block';
        }
    } catch (error) {
        statusElement.innerHTML = '<span class="status-badge status-failed">실패</span>';
        resultElement.innerHTML = `<div class="error-message">❌ 진단 중 오류가 발생했습니다: ${error.message}</div>`;
        resultElement.style.display = 'block';
    }
}

// 서버 상태 체크
async function checkServerStatus() {
    try {
        const response = await fetch('/diagnosis/api/test-session', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                account_id: 'test'
            })
        });
        return response.headers.get('content-type')?.includes('application/json');
    } catch (error) {
        return false;
    }
}

// 전체 진단 실행 (개별 순차 실행으로 변경)
async function runAllDiagnosis() {
    if (!selectedAccountId) {
        alert('계정을 선택해주세요.');
        return;
    }
    
    if (diagnosisInProgress) {
        alert('이미 진단이 진행 중입니다.');
        return;
    }
    
    // 서버 상태 체크
    const serverOk = await checkServerStatus();
    if (!serverOk) {
        alert('⚠️ Flask 서버가 실행되지 않았거나 API 엔드포인트에 접근할 수 없습니다.\n\n다음을 확인해주세요:\n1. Flask 서버가 실행 중인지 확인\n2. python run.py 명령으로 서버 시작\n3. 브라우저 콘솔에서 오류 메시지 확인');
        return;
    }
    
    diagnosisInProgress = true;
    
    // 진행 상태 패널 표시
    showProgressPanel();
    
    // 모든 진단 항목을 대기 상태로 변경
    const allItems = document.querySelectorAll('.diagnosis-item');
    const itemCodes = Array.from(allItems).map(item => item.dataset.itemCode);
    
    // 진단 항목들을 대기 상태로 설정
    itemCodes.forEach(itemCode => {
        setItemStatus(itemCode, 'waiting');
    });
    
    let completedCount = 0;
    let failedCount = 0;
    const totalItems = itemCodes.length;
    
    addDebugLog(`전체 진단 시작 - 총 ${totalItems}개 항목`);
    updateCurrentStatus('전체 진단 시작 중...');
    
    try {
        // 각 항목을 순차적으로 실행
        for (let i = 0; i < itemCodes.length; i++) {
            const itemCode = itemCodes[i];
            const itemName = getItemNameByCode(itemCode);
            
            // 현재 실행 중인 항목 표시
            setItemStatus(itemCode, 'running');
            updateCurrentStatus(`[${i + 1}/${totalItems}] ${itemCode} ${itemName} 진단 중...`);
            addDebugLog(`📋 [${itemCode}] ${itemName} 진단 시작`);
            
            // 현재 진단 중인 항목으로 스크롤 이동
            scrollToCurrentItem(itemCode);
            
            try {
                await runSingleDiagnosisQuiet(itemCode);
                setItemStatus(itemCode, 'completed');
                completedCount++;
                addDebugLog(`✅ [${itemCode}] 진단 완료`);
            } catch (error) {
                setItemStatus(itemCode, 'completed'); // 실패해도 버튼은 복구
                failedCount++;
                addDebugLog(`❌ [${itemCode}] 진단 실패: ${error.message}`);
            }
            
            // 진행률 업데이트
            const progressPercentage = Math.round(((i + 1) / totalItems) * 100);
            updateProgressStats(progressPercentage, completedCount, failedCount);
            
            // 진단 간 잠시 대기 (UI 업데이트를 위해)
            await new Promise(resolve => setTimeout(resolve, 200));
        }
        
        // 완료 처리
        updateCurrentStatus(`전체 진단 완료! 성공: ${completedCount}개, 실패: ${failedCount}개`);
        addDebugLog(`🎉 전체 진단 완료 - 성공: ${completedCount}개, 실패: ${failedCount}개`);
        
        // 진단 완료 상태로 변경 (패널은 숨기지 않음)
        markDiagnosisCompleted(completedCount, failedCount, totalItems);
        
        // 전체 진단 완료 후 맨 위로 부드럽게 스크롤
        setTimeout(() => {
            window.scrollTo({
                top: 0,
                behavior: 'smooth'
            });
        }, 1000);
        
    } catch (error) {
        addDebugLog(`❌ 전체 진단 중 오류 발생: ${error.message}`);
        updateCurrentStatus(`진단 중 오류 발생: ${error.message}`);
    } finally {
        diagnosisInProgress = false;
    }
}

// 진단 결과 표시
function displayDiagnosisResult(itemCode, result) {
    const resultElement = document.getElementById(`result-${itemCode}`);
    const diagnosisResult = result.result;
    
    let resultHTML = '<div class="result-summary">';
    
    if (diagnosisResult.status === 'success') {
        resultHTML += `<div class="result-item">
            <strong>위험도:</strong> <span class="risk-level risk-${diagnosisResult.risk_level}">${diagnosisResult.risk_level}</span>
        </div>`;
        
        if (diagnosisResult.has_issues) {
            resultHTML += '<div class="result-item"><strong>⚠️ 보안 이슈가 발견되었습니다</strong></div>';
        } else {
            resultHTML += '<div class="result-item"><strong>✅ 보안 이슈가 발견되지 않았습니다</strong></div>';
        }
        
        // 요약 정보 표시
        if (diagnosisResult.summary) {
            resultHTML += `<div class="result-item"><strong>summary:</strong> ${diagnosisResult.summary}</div>`;
        }
        
        // 상세 정보가 있으면 구조화된 형태로 표시
        if (diagnosisResult.details && typeof diagnosisResult.details === 'object') {
            resultHTML += '<div class="result-details">';
            Object.entries(diagnosisResult.details).forEach(([key, value]) => {
                if (typeof value === 'object' && value !== null) {
                    resultHTML += `<div class="detail-section"><strong>${key}:</strong>`;
                    if (value.count !== undefined) {
                        resultHTML += ` ${value.count}개`;
                    }
                    if (value.users && Array.isArray(value.users)) {
                        resultHTML += ` (${value.users.join(', ')})`;
                    }
                    if (value.description) {
                        resultHTML += ` - ${value.description}`;
                    }
                    resultHTML += '</div>';
                } else {
                    resultHTML += `<div class="result-item"><strong>${key}:</strong> ${value}</div>`;
                }
            });
            resultHTML += '</div>';
        }
        
        // 자동 조치 옵션 표시
        if (diagnosisResult.fix_options && Array.isArray(diagnosisResult.fix_options)) {
            resultHTML += '<div class="fix-options">';
            resultHTML += '<strong>자동 조치 옵션:</strong>';
            diagnosisResult.fix_options.forEach((option, index) => {
                resultHTML += `
                    <div class="fix-option">
                        <div class="fix-option-header">
                            <h4>${option.title}</h4>
                            <p>${option.description}</p>
                        </div>
                        <div class="fix-option-items">
                            ${option.items.map(item => `
                                <label class="fix-item">
                                    <input type="checkbox" value="${item.id}" data-option-id="${option.id}" checked>
                                    <span>${item.name} - ${item.description}</span>
                                </label>
                            `).join('')}
                        </div>
                        <button class="btn btn-warning btn-fix" onclick="executeFix('${itemCode}', '${option.id}')">
                            <span>⚡</span> ${option.title} 실행
                        </button>
                    </div>
                `;
            });
            resultHTML += '</div>';
        }
        
        // 수동 조치 가이드 표시
        if (diagnosisResult.manual_guide) {
            const guide = diagnosisResult.manual_guide;
            resultHTML += '<div class="manual-guide-box">';
            resultHTML += `<div class="manual-guide-header">
                <h4>📋 ${guide.title}</h4>
                <p class="manual-guide-description">${guide.description}</p>
            </div>`;
            
            if (guide.steps && Array.isArray(guide.steps)) {
                resultHTML += '<div class="manual-guide-steps">';
                guide.steps.forEach((step, index) => {
                    let stepClass = 'manual-step';
                    if (step.type === 'warning') stepClass += ' step-warning';
                    else if (step.type === 'danger') stepClass += ' step-danger';
                    else if (step.type === 'info') stepClass += ' step-info';
                    else if (step.type === 'step') stepClass += ' step-action';
                    else if (step.type === 'commands') stepClass += ' step-commands';
                    
                    resultHTML += `<div class="${stepClass}">`;
                    resultHTML += `<div class="step-title">${step.title}</div>`;
                    
                    if (step.type === 'commands' && Array.isArray(step.content)) {
                        resultHTML += '<div class="step-content commands-content">';
                        step.content.forEach(command => {
                            // 빈 문자열이거나 공백만 있는 경우 줄바꿈으로 처리
                            if (!command || command.trim() === '') {
                                resultHTML += '<div class="command-separator"></div>';
                                return;
                            }
                            
                            // HTML과 JavaScript에서 안전하게 사용하기 위해 이스케이프 처리
                            const escapedCommand = command.replace(/'/g, '&#39;').replace(/"/g, '&quot;');
                            const safeCommand = command.replace(/'/g, "\\'").replace(/"/g, '\\"');
                            
                            resultHTML += `<div class="command-line">
                                <code>${escapedCommand}</code>
                                <button class="btn btn-xs btn-copy" onclick="copyToClipboard('${safeCommand}')">📋</button>
                            </div>`;
                        });
                        resultHTML += '</div>';
                    } else {
                        resultHTML += `<div class="step-content">${step.content}</div>`;
                    }
                    resultHTML += '</div>';
                });
                resultHTML += '</div>';
            }
            resultHTML += '</div>';
        }
    } else {
        resultHTML += `<div class="error-message">❌ ${diagnosisResult.error_message}</div>`;
    }
    
    resultHTML += '</div>';
    
    resultElement.innerHTML = resultHTML;
    resultElement.style.display = 'block';
}


// 자동 조치 실행
async function executeFix(itemCode, optionId) {
    if (!selectedAccountId) {
        alert('계정을 선택해주세요.');
        return;
    }
    
    // 선택된 항목들 수집
    const checkboxes = document.querySelectorAll(`input[data-option-id="${optionId}"]:checked`);
    if (checkboxes.length === 0) {
        alert('조치할 항목을 선택해주세요.');
        return;
    }
    
    const selectedItems = {};
    selectedItems[optionId] = Array.from(checkboxes).map(cb => ({
        id: cb.value,
        name: cb.value,
        description: cb.parentElement.textContent.trim()
    }));
    
    // 확인 메시지
    const itemCount = checkboxes.length;
    const confirmMessage = `정말로 ${itemCount}개 항목에 대해 자동 조치를 실행하시겠습니까?\n\n⚠️ 이 작업은 되돌릴 수 없습니다.`;
    
    if (!confirm(confirmMessage)) {
        return;
    }
    
    try {
        // 실행 버튼 비활성화
        const executeButton = event.target;
        const originalText = executeButton.innerHTML;
        executeButton.disabled = true;
        executeButton.innerHTML = '<span>⏳</span> 실행 중...';
        
        const response = await fetch('/diagnosis/api/fix', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                account_id: selectedAccountId,
                item_code: itemCode,
                selected_items: selectedItems
            })
        });
        
        const result = await response.json();
        
        if (result.status === 'success') {
            let successCount = 0;
            let failCount = 0;
            let message = '자동 조치 실행 결과:\n\n';
            
            result.results.forEach(res => {
                if (res.status === 'success') {
                    successCount++;
                    message += `✅ ${res.message}\n`;
                } else {
                    failCount++;
                    message += `❌ ${res.message}\n`;
                }
            });
            
            message += `\n성공: ${successCount}개, 실패: ${failCount}개`;
            alert(message);
            
            // 성공했으면 해당 항목 재진단
            if (successCount > 0) {
                setTimeout(() => {
                    runSingleDiagnosis(itemCode);
                }, 1000);
            }
        } else {
            alert(`❌ 자동 조치 실패\n${result.message}`);
        }
        
        // 버튼 복구
        executeButton.disabled = false;
        executeButton.innerHTML = originalText;
        
    } catch (error) {
        alert(`자동 조치 실행 중 오류가 발생했습니다: ${error.message}`);
        
        // 버튼 복구
        const executeButton = event.target;
        executeButton.disabled = false;
        executeButton.innerHTML = originalText;
    }
}

// 재진단
function rediagnose(button) {
    const itemElement = button.closest('.diagnosis-item');
    const itemCode = itemElement.dataset.itemCode;
    runSingleDiagnosis(itemCode);
}

// 진행 상태 사이드바 표시/숨기기
function showProgressPanel() {
    document.getElementById('progressSidebar').style.display = 'block';
    resetProgressStats();
}

function hideProgressPanel() {
    document.getElementById('progressSidebar').style.display = 'none';
}

// 진단 완료 상태로 변경
function markDiagnosisCompleted(completedCount, failedCount, totalItems) {
    // 사이드바 제목을 완료 상태로 변경
    const sidebarTitle = document.querySelector('#progressSidebar h4');
    if (sidebarTitle) {
        sidebarTitle.innerHTML = `
            <span class="text-lg mr-2">✅</span>
            진단 완료
        `;
    }
    
    // 완료 요약 정보 추가
    const completionRate = Math.round((completedCount / totalItems) * 100);
    addDebugLog(`📊 완료율: ${completionRate}% (${completedCount}/${totalItems})`);
    
    // 현재 상태를 완료 상태로 고정
    updateCurrentStatus(`진단 완료 - 성공률: ${completionRate}%`);
    
    // 사이드바 배경색을 완료 상태로 변경
    const progressSidebar = document.getElementById('progressSidebar');
    if (progressSidebar) {
        progressSidebar.style.borderLeft = '4px solid #10b981';
        progressSidebar.style.backgroundColor = '#f0fdf4';
    }
}

// 진행 상태 초기화
function resetProgressStats() {
    updateProgressStats(0, 0, 0);
    updateCurrentStatus('진단 준비 중...');
    clearDebugLog();
    addDebugLog('진단 시작 준비 중...');
    
    // 사이드바 초기 상태로 리셋
    const sidebarTitle = document.querySelector('#progressSidebar h4');
    if (sidebarTitle) {
        sidebarTitle.innerHTML = `
            <span class="text-lg mr-2">🚀</span>
            진단 진행 상황
        `;
    }
    
    // 사이드바 배경색 초기화
    const progressSidebar = document.getElementById('progressSidebar');
    if (progressSidebar) {
        progressSidebar.style.borderLeft = '';
        progressSidebar.style.backgroundColor = '';
    }
}

// 진행 상태 업데이트
function updateProgressStats(percentage, completed, failed) {
    document.getElementById('progressPercentageValue').textContent = `${percentage}%`;
    document.getElementById('completedCountValue').textContent = completed;
    document.getElementById('failedCountValue').textContent = failed;
    document.getElementById('progressFillBar').style.width = `${percentage}%`;
}

// 현재 상태 메시지 업데이트
function updateCurrentStatus(message) {
    document.getElementById('currentStatusText').textContent = message;
}

// 디버그 로그 추가
function addDebugLog(message) {
    const logContainer = document.getElementById('debugLogList');
    const logEntry = document.createElement('div');
    
    // 메시지 타입에 따라 색상 결정
    let colorClass = 'text-gray-300'; // 기본
    if (message.includes('✅') || message.includes('완료')) {
        colorClass = 'text-green-400';
    } else if (message.includes('❌') || message.includes('실패')) {
        colorClass = 'text-red-400';
    } else if (message.includes('📋') || message.includes('시작')) {
        colorClass = 'text-blue-400';
    } else if (message.includes('🎉')) {
        colorClass = 'text-yellow-400';
    }
    
    logEntry.className = `${colorClass} font-mono mb-1 text-xs`;
    logEntry.textContent = `[${new Date().toLocaleTimeString()}] ${message}`;
    logContainer.appendChild(logEntry);
    
    // 스크롤을 맨 아래로
    logContainer.scrollTop = logContainer.scrollHeight;
    
    // 로그 항목이 너무 많으면 오래된 것 제거
    const logEntries = logContainer.children;
    if (logEntries.length > 20) {
        logContainer.removeChild(logEntries[0]);
    }
}

// 디버그 로그 초기화
function clearDebugLog() {
    const logContainer = document.getElementById('debugLogList');
    logContainer.innerHTML = '<div class="text-green-400 font-mono">진단 시작 준비 중...</div>';
}

// 항목 상태 설정
function setItemStatus(itemCode, status) {
    const itemElement = document.querySelector(`[data-item-code="${itemCode}"]`);
    if (!itemElement) {
        console.warn(`항목을 찾을 수 없습니다: ${itemCode}`);
        return;
    }
    
    const actionButton = itemElement.querySelector('.item-actions .btn:not(.btn-disabled)');
    if (!actionButton) {
        console.warn(`진단 버튼을 찾을 수 없습니다: ${itemCode}`);
        return;
    }
    
    const resultElement = document.getElementById(`result-${itemCode}`);
    
    if (status === 'waiting') {
        actionButton.innerHTML = '<span>⏳</span> 대기 중';
        actionButton.disabled = true;
        if (resultElement) {
            resultElement.style.display = 'none';
        }
    } else if (status === 'running') {
        actionButton.innerHTML = '<span>🔄</span> 실행 중';
        actionButton.disabled = true;
    } else if (status === 'completed') {
        actionButton.innerHTML = '<span>🎯</span> 진단 실행';
        actionButton.disabled = false;
    }
}

// 항목 코드로 이름 조회
function getItemNameByCode(itemCode) {
    const itemElement = document.querySelector(`[data-item-code="${itemCode}"]`);
    if (!itemElement) return itemCode;
    
    const titleElement = itemElement.querySelector('.item-name');
    return titleElement ? titleElement.textContent.trim() : itemCode;
}

// 현재 진단 중인 항목으로 스크롤 이동
function scrollToCurrentItem(itemCode) {
    const itemElement = document.querySelector(`[data-item-code="${itemCode}"]`);
    if (itemElement) {
        // 부드럽게 스크롤하면서 항목을 화면 중앙에 배치
        itemElement.scrollIntoView({
            behavior: 'smooth',
            block: 'center',
            inline: 'nearest'
        });
        
        // 현재 진단 중인 항목 강조 효과
        highlightCurrentItem(itemCode);
    }
}

// 현재 진단 중인 항목 강조 효과
function highlightCurrentItem(itemCode) {
    // 기존 강조 효과 제거
    document.querySelectorAll('.diagnosis-item').forEach(item => {
        item.classList.remove('current-diagnosing');
    });
    
    // 현재 항목에 강조 효과 추가
    const currentItem = document.querySelector(`[data-item-code="${itemCode}"]`);
    if (currentItem) {
        currentItem.classList.add('current-diagnosing');
        
        // 3초 후 강조 효과 제거 (진단이 완료되면)
        setTimeout(() => {
            currentItem.classList.remove('current-diagnosing');
        }, 3000);
    }
}

// 조용한 단일 진단 (로그 없이)
async function runSingleDiagnosisQuiet(itemCode) {
    const response = await fetch('/diagnosis/api/run', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        },
        body: JSON.stringify({
            account_id: selectedAccountId,
            item_code: itemCode
        })
    });
    
    // 응답이 JSON인지 확인
    const contentType = response.headers.get('content-type');
    if (!contentType || !contentType.includes('application/json')) {
        const text = await response.text();
        console.error('JSON이 아닌 응답:', text);
        throw new Error(`서버에서 HTML을 반환했습니다. Flask 서버가 올바르게 실행되고 있는지 확인하세요.`);
    }
    
    const result = await response.json();
    
    if (result.status === 'success') {
        displayDiagnosisResult(itemCode, result);
    } else {
        throw new Error(result.message || '진단 실패');
    }
}

// 클립보드 복사
async function copyToClipboard(text) {
    try {
        await navigator.clipboard.writeText(text);
        // 임시 알림 표시 (선택사항)
        const button = event.target;
        const originalText = button.textContent;
        button.textContent = '✅';
        setTimeout(() => {
            button.textContent = originalText;
        }, 1000);
    } catch (err) {
        // 클립보드 API가 지원되지 않는 경우 fallback
        const textArea = document.createElement('textarea');
        textArea.value = text;
        document.body.appendChild(textArea);
        textArea.select();
        try {
            document.execCommand('copy');
            const button = event.target;
            const originalText = button.textContent;
            button.textContent = '✅';
            setTimeout(() => {
                button.textContent = originalText;
            }, 1000);
        } catch (err) {
            alert('클립보드 복사에 실패했습니다.');
        }
        document.body.removeChild(textArea);
    }
}

// 페이지 로드 시 선택된 계정이 있으면 자동 선택
document.addEventListener('DOMContentLoaded', function() {
    {% if selected_account %}
    selectedAccountId = '{{ selected_account.account_id }}';
    
    // 제어판과 진단 항목이 존재하면 표시
    const controlPanel = document.getElementById('controlPanel');
    const diagnosisItems = document.getElementById('diagnosisItems');
    
    if (controlPanel) {
        controlPanel.style.display = 'block';
    }
    if (diagnosisItems) {
        diagnosisItems.style.display = 'block';
    }
    {% endif %}
});
</script>
{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/pages/diagnosis.css') }}">
{% endblock %}